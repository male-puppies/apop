local log = require("log")
local js = require("cjson.safe")
local const = require("constant")
local country = require("country")

local bandwidth = {
	["2g"] = {
		["b"] = 	{"20"}, 
		["g"] = 	{"20"},
		["n"] = 	{"AUTO", "20", "40+", "40-"},
		["bg"] = 	{"20"},
		["bgn"] = 	{"AUTO", "20", "40+", "40-"},
	},
	["5g"] = {
		["a"] = 	{"20"},
		["n"] = 	{"AUTO", "20", "40+", "40-"}, 
		["an"] = 	{"AUTO", "20", "40+", "40-"},
	}
}

local channel = {
	["China"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},	
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,149,153,157,161,165}, 	recommend = {149,153,157,161,165}},
			["40"] = {	all = 	{0,149,153,157,161}, 		recommend = {149,153,157,161}},
			["AUTO"] = {all =  	{0,149,153,157,161}, 		recommend = {149,153,157,161}},	
			["40+"] = {	all = 	{149,157}, recommend = {}},	
			["40-"] = {	all = 	{153,161}, recommend = {}},
		},
	},
	["US"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},	
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140,149,153,157,161,165}, 	recommend = {36,40,44,48,149,153,157,161,165}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}, 	recommend = {36,40,44,48,149,153,157,161}},
			["AUTO"] = {all =  	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}, 	recommend = {36,40,44,48,149,153,157,161}},
			["40+"] = {	all = 	{36,44,52,60,100,108,116,124,132,149,157}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,104,112,120,128,136,153,161}, recommend = {}},
		},
	},
	["JP"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},	
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140}, 	recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136}, 		recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136}},
			["AUTO"] = {all =  	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136}, 		recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136}},	
			["40+"] = {	all = 	{36,44,52,60,100,108,116,124,132}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,104,112,120,128,136}, recommend = {}},
		},
	},
	["KR"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,3,4,5,6,7,8,9,10,11},			recommend = {6,11}},
			["AUTO"] = {all = 	{0,3,4,5,6,7,8,9,10,11}, 			recommend = {6,11}},
			["40+"] = {	all = 	{3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,149,153,157,161}, 	recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,149,153,157,161}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,149,153,157,161}, 	recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,149,153,157,161}},
			["AUTO"] = {all =  	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,149,153,157,161}, 	recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,149,153,157,161}},	
			["40+"] = {	all = 	{36,44,52,60,100,108,116,124,149,157}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,104,112,120,128,153,161}, recommend = {}},
		},
	},
	["MY"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,149,153,157,161,165}, 	recommend = {52,56,60,64,149,153,157,161,165}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,149,153,157,161}, 		recommend = {36,40,44,48,52,56,60,64,149,153,157,161}},
			["AUTO"] = {all =  	{0,36,40,44,48,52,56,60,64,149,153,157,161}, 		recommend = {36,40,44,48,52,56,60,64,149,153,157,161}},	
			["40+"] = {	all = 	{36,44,52,60,149,157}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,153,161}, recommend = {}},
		},
	},
	["IN"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},	
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,149,153,157,161,165}, 	recommend = {36,40,44,48,52,56,60,64,149,153,157,161,165}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,149,153,157,161}, 		recommend = {36,40,44,48,149,153,157,161}},
			["AUTO"] = {all =  	{0,36,40,44,48,52,56,60,64,149,153,157,161}, 		recommend = {36,40,44,48,149,153,157,161}},	
			["40+"] = {	all = 	{36,44,52,60,149,157}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,153,161}, recommend = {}},
		},
	},
	["TH"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140,149,153,157,161,165}, 	recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140,149,153,157,161,165}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}, 			recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}},
			["AUTO"] = {all =  	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}, 			recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}},
			["40+"] = {	all = 	{36,44,52,60,100,108,116,124,132,149,157}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,104,112,120,128,136,153,161}, recommend = {}},
		},
	},
	["VN"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},	
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,}, recommend = {1,6,11}},
			["AUTO"] = {all =  	{0,}, recommend = {1,6,11}},		
			["40+"] = {	all = 	{}, recommend = {}},	
			["40-"] = {	all = 	{}, recommend = {}},
		},
	},
	["VN"] = {
		["2g"] = {
			["20"] = {	all = 	{0,}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,}, recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,}, recommend = {1,6,11}},	
			["40+"] = {	all = 	{}, 	recommend = {}},	
			["40-"] = {	all = 	{}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140,149,153,157,161,165}, recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140,149,153,157,161,165}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}, recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}},
			["AUTO"] = {all =  	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}, recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,149,153,157,161}},		
			["40+"] = {	all = 	{36,44,52,60,100,108,116,124,132,149,157}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,104,112,120,128,136,153,161}, recommend = {}},
		},
	},
	["ID"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},	
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{}, recommend = {}},
			["40"] = {	all = 	{}, recommend = {}},
			["AUTO"] = {all =  	{}, recommend = {}},		
			["40+"] = {	all = 	{}, recommend = {}},	
			["40-"] = {	all = 	{}, recommend = {}},
		},
	},
	["GB"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, recommend = {1,6,11}},	
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140}, 	recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136}, 		recommend = {36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136}},
			["AUTO"] = {all =  	{0,}, recommend = {1,6,11}},		
			["40+"] = {	all = 	{36,44,52,60,100,108,116,124,132}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,104,112,120,128,136}, recommend = {}},
		},
	},
	["SG"] = {
		["2g"] = {
			["20"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11,12,13}, recommend = {1,6,11}},
			["40"] = {	all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},
			["AUTO"] = {all = 	{0,1,2,3,4,5,6,7,8,9,10,11}, 		recommend = {1,6,11}},	
			["40+"] = {	all = 	{1,2,3,4,5,6,7}, 	recommend = {}},	
			["40-"] = {	all = 	{5,6,7,8,9,10,11}, 	recommend = {}},			
		},
		["5g"] = {
			["20"] = {	all = 	{0,36,40,44,48,52,56,60,64,149,153,157,161,165}, 	recommend = {36,40,44,48,52,56,60,64,149,153,157,161,165}},
			["40"] = {	all = 	{0,36,40,44,48,52,56,60,64,149,153,157,161}, 		recommend = {36,40,44,48,52,56,60,64,149,153,157,161}},
			["AUTO"] = {all =  	{0,36,40,44,48,52,56,60,64,149,153,157,161}, 		recommend = {36,40,44,48,52,56,60,64,149,153,157,161}},	
			["40+"] = {	all = 	{36,44,52,60,149,157}, recommend = {}},	
			["40-"] = {	all = 	{40,48,56,64,153,161}, recommend = {}},
		},
	},
}

local function get_bandwidth(band, mode)
	return bandwidth[band][mode]
end

local function get_channel(country, band, bandwidth)
	bandwidth = bandwidth:upper()
	return channel[country][band][bandwidth]
end

local function validate_channel(param)
	local ctry = country.short(param.country)
	local channel_map = get_channel(ctry, param.band, param.bandwidth)
	local _ = channel_map or log.fatal("invalid channel %s %s %s %s", param.country, ctry or "", param.band, param.bandwidth)
	
	local channel_id = tostring(param.channel_id):upper()
	local find, target = false, channel_id == "AUTO" and 0 or tonumber(channel_id)	assert(target)
	for _, channel_id in ipairs(channel_map.all) do 
		if channel_id == target then 
			find = true 
			break 
		end 
	end

	local _ = find or log.fatal("invalid channel %s %s", js.encode(channel_map), js.encode(param))
end

local function validate_bandwidth(param)
	local bandwidth_arr = get_bandwidth(param.band, param.protocol) 
	local _ = bandwidth_arr or log.fatal("invalid bandwidth %s %s", param.band, param.protocol)
	
	local find = false
	for _, bandwidth in ipairs(bandwidth_arr) do 
		if bandwidth == param.bandwidth then 
			find = true 
			break 
		end
	end

	local _ = find or log.fatal("invalid bandwidth %s %s", js.encode(bandwidth_arr), js.encode(param))
	validate_channel(param)
end

return {
	channel = get_channel,
	bandwidth = get_bandwidth,  
	validate_channel = validate_channel,
	validate_bandwidth = validate_bandwidth,
}

